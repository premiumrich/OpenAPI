pipelines:
  default:
    - step: &generate-sdks
        name: Generate SDKs
        image: timbru31/java-node:8-jdk-14
        caches:
          - node
        script:
          - npm install
          - npm run generate
        artifacts:
          - dist/**
    - parallel:
        - step: &check-sdk-versions
            name: Check SDK versions
            image: atlassian/default-image:2
            script:
              - bash scripts/check-versions.sh
        - step: &run-javascript-tests
            name: Run JavaScript tests
            image: node:14.16
            caches:
              - node
            script:
              - cd dist/sdk-javascript/
              - npm install
              - npm run test:junit-report
        - step: &run-php-tests
            name: Run PHP tests
            image: php:7.4
            caches:
              - composer
            script:
              - apt-get update && apt-get install -y unzip git
              - pecl install pcov && docker-php-ext-enable pcov
              - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
              - cd dist/sdk-php/
              - composer install
              - bash run-tests.sh
        - step: &run-python-tests
            name: Run Python tests
            image: python:3.9.1
            caches:
              - pip
            script:
              - python -m pip install tox
              - cd dist/sdk-python/
              - python -m tox
        - step: &run-java-tests
            name: Run Java tests
            image: maven:3.6.3-jdk-8
            caches:
              - maven
            script:
              - cd dist/sdk-java/
              - mvn -B test
        - step: &run-ruby-tests
            name: Run Ruby tests
            image: ruby:2.7
            caches:
              - bundler
            script:
              - cd dist/sdk-ruby/
              - bundle install --path vendor/bundle/
              - bundle exec rake test
              - gem build --strict --verbose *.gemspec
  branches:
    master:
      - step: *generate-sdks
      - parallel:
          - step: *check-sdk-versions
          - step: *run-javascript-tests
          - step: *run-php-tests
          - step: *run-python-tests
          - step: *run-java-tests
          - step: *run-ruby-tests
      - step:
          name: Deploy to QA Branch
          deployment: QA Branch
          trigger: manual
          image: atlassian/default-image:2
          script:
            - git push origin master:qa
    qa:
      - step: *generate-sdks
      - parallel:
          - step: *check-sdk-versions
          - step: *run-javascript-tests
          - step: *run-php-tests
          - step: *run-python-tests
          - step: *run-java-tests
          - step: *run-ruby-tests
      - step:
          name: Deploy to SDK Repos
          deployment: SDK Repos
          trigger: manual
          image: atlassian/default-image:2
          script:
            - bash automation/deploy-sdk-repos.sh
      - step:
          name: Deploy to GitHub Repo
          deployment: GitHub Repo
          trigger: manual
          image: atlassian/default-image:2
          script:
            - git push "https://${GITHUB_TOKEN}@github.com/Trulioo/OpenAPI" qa:master

definitions:
  caches:
    bundler: dist/sdk-ruby/vendor/bundle/
